#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency, if available
if [ -z "${LD_PRELOAD+x}" ]; then
  JEMALLOC_PATH=$(find /usr/lib -name libjemalloc.so.2 -print -quit 2>/dev/null)
  if [ -n "$JEMALLOC_PATH" ]; then
    export LD_PRELOAD="$JEMALLOC_PATH"
    echo "Enabled jemalloc with LD_PRELOAD=$LD_PRELOAD"
  else
    echo "Warning: libjemalloc.so.2 not found, skipping jemalloc"
  fi
fi

# If running the rails server, create or migrate existing database
if [[ "$*" =~ ./bin/rails\ server ]]; then
  echo "Preparing database..."
  ./bin/rails db:prepare || { echo "Error: Database preparation failed"; exit 1; }
fi

exec "$@"